{% extends "base.html" %}
{% block title %}Search ‚Äî Neural Breach{% endblock %}
{% block content %}
<div class="page-header">
  <div class="container" style="padding:0">
    <h1 class="fade-up">SEARCH <span>RESOURCES</span></h1>
    <p class="page-subtitle fade-up delay-1">Browse and filter academic materials</p>
  </div>
</div>

<div class="container" style="padding-bottom:3rem">
  <form method="GET" action="{{ url_for('search') }}">
    <!-- Search Bar -->
    <div class="search-bar fade-up">
      <input type="text" name="q" value="{{ query }}" placeholder="Search by title, subject, tags...">
      <button type="submit" class="btn btn-primary">‚åï SEARCH</button>
    </div>

    <div class="search-layout">
      <!-- Filters Sidebar -->
      <aside class="search-filters fade-up delay-1">
        <div class="card filter-card">
          <div class="filter-title">‚å¨ FILTERS</div>

          <div class="filter-group">
            <label>SUBJECT / COURSE</label>
            <input type="text" name="subject" value="{{ subject }}" placeholder="Any subject">
          </div>
          <div class="filter-group">
            <label>SEMESTER</label>
            <select name="semester">
              <option value="">All semesters</option>
              {% for i in range(1, 9) %}
              <option value="{{ i }}" {% if semester == i|string %}selected{% endif %}>Semester {{ i }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label>RESOURCE TYPE</label>
            <select name="type">
              <option value="">All types</option>
              {% for t in ['Notes','Question Papers','Solutions','Project Reports','Study Material','Lab Manual','Other'] %}
              <option value="{{ t }}" {% if resource_type == t %}selected{% endif %}>{{ t }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="filter-group">
            <label>BRANCH</label>
            <input type="text" name="branch" value="{{ request.args.get('branch','') }}" placeholder="Any branch">
          </div>
          <div class="filter-group">
            <label>YEAR / BATCH</label>
            <input type="text" name="year_batch" value="{{ request.args.get('year_batch','') }}" placeholder="e.g. 2024-25">
          </div>
          <div class="filter-group">
            <label>PRIVACY</label>
            <select name="privacy">
              <option value="">All</option>
              <option value="public" {% if request.args.get('privacy') == 'public' %}selected{% endif %}>üåê Public Only</option>
              <option value="private" {% if request.args.get('privacy') == 'private' %}selected{% endif %}>üîí Private (Your College)</option>
            </select>
          </div>

          <hr class="divider">
          <button type="submit" class="btn btn-primary btn-full btn-sm">APPLY FILTERS</button>
          <a href="{{ url_for('search') }}" class="btn btn-outline btn-full btn-sm" style="margin-top:0.5rem;">‚úï CLEAR ALL</a>
        </div>
      </aside>

      <!-- Results -->
      <div class="search-results fade-up delay-2">
        <div class="results-header">
          <div class="results-count">
            {% if resources %}
              {{ resources|length }} result{% if resources|length != 1 %}s{% endif %}
              {% if query %} for "<span style="color:var(--cyan)">{{ query }}</span>"{% endif %}
            {% else %}
              No results found
            {% endif %}
          </div>
          <div class="sort-bar">
            <select name="sort" onchange="this.form.submit()">
              <option value="latest" {% if sort == 'latest' %}selected{% endif %}>Latest First</option>
              <option value="popular" {% if sort == 'popular' %}selected{% endif %}>Most Downloaded</option>
              <option value="rated" {% if sort == 'rated' %}selected{% endif %}>Highest Rated</option>
            </select>
          </div>
        </div>

        {% if resources %}
        <div class="resource-grid">
          {% for res in resources %}
          <div class="card resource-card">
            <a href="{{ url_for('resource_detail', resource_id=res.id) }}">
              <div class="rc-header">
                <span class="rc-icon">{{ res.original_filename | file_icon }}</span>
                <div class="rc-info">
                  <div class="rc-title" title="{{ res.title }}">{{ res.title }}</div>
                  <div class="rc-subject">{{ res.subject }}</div>
                </div>
              </div>
              <div class="rc-body">
                <div class="rc-meta">
                  <span class="tag tag-type">{{ res.resource_type }}</span>
                  <span class="tag tag-sem">SEM {{ res.semester }}</span>
                  {% if res.privacy == 'private' %}
                  <span class="tag tag-priv">üîí PRIVATE</span>
                  {% else %}
                  <span class="tag tag-pub">üåê PUBLIC</span>
                  {% endif %}
                </div>
                {% if res.tags %}
                <div style="display:flex; flex-wrap:wrap; gap:0.3rem; margin-bottom:0.5rem;">
                  {% for tag in res.tags.split(',')[:3] %}
                  <span class="tag tag-keyword">{{ tag.strip() }}</span>
                  {% endfor %}
                </div>
                {% endif %}
                <div class="rc-uploader">‚Üë {{ res.uploader_name }} ¬∑ {{ res.uploader_college[:22] }}</div>
              </div>
              <div class="rc-footer">
                <div class="rc-rating">
                  <span class="stars">{% for i in range(5) %}{% if i < res.avg_rating|int %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</span>
                  <span style="font-size:0.75rem; color:var(--text-dim)">{{ res.avg_rating }}</span>
                </div>
                <div class="rc-stats">
                  <span>‚¨á {{ res.download_count }}</span>
                  <span>{{ res.created_at | timeago }}</span>
                </div>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="card no-results">
          <span class="no-results-icon">‚åï</span>
          <p style="margin-bottom:0.5rem">No resources match your filters.</p>
          <p style="font-size:0.8rem">Try a different search term or clear the filters.</p>
          {% if session.user_id %}
          <a href="{{ url_for('upload') }}" class="btn btn-primary btn-sm" style="margin-top:1rem;">‚Üë Be the first to upload</a>
          {% endif %}
        </div>
        {% endif %}
      </div>
    </div>
  </form>
</div>
{% endblock %}
